name: Validate on Developer Sandbox

on:
    push:
        paths:
            - 'force-app/**'
        branches:
            - feature/*
            - bugfix/*
            - hotfix/*
    pull_request:
        branches:
            - develop

jobs:
    validate:
        runs-on: ubuntu-latest
        environment: developer
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4.1.7
              with:
                  fetch-depth: 0

            - name: Install npm dependencies
              run: npm install

            - name: Install Salesforce CLI
              run: npm install @salesforce/cli --global

            - name: Decrypt JWT Key File
              run: |
                  openssl enc -nosalt -aes-256-cbc -d \
                  -in ${{ secrets.DEVELOPER_ENCRYPTED_KEY_FILE }} \
                  -out ${{ secrets.DEVELOPER_JWT_KEY_FILE }} \
                  -base64 -K ${{ secrets.DEVELOPER_KEY }} -iv ${{ secrets.DEVELOPER_IV }}

            - name: Authorize Developer Org
              run: |
                  sf org login jwt \
                  --username ${{ secrets.DEVELOPER_USERNAME }} \
                  --jwt-key-file ${{ secrets.DEVELOPER_JWT_KEY_FILE }} \
                  --client-id ${{ secrets.DEVELOPER_CLIENT_ID }} \
                  --instance-url ${{ secrets.DEVELOPER_INSTANCE_URL }} \
                  --alias dev-sandbox

            - name: Validate Deployment
              run: sf project deploy validate --target-org dev
